#!/bin/bash

if [ -z "$1" ]; then
  echo "❌ Bạn cần truyền đường dẫn thư mục cần quét."
  echo "✅ Cách dùng: ./scan-malware.sh /duong/dan/thu-muc"
  exit 1
fi

PROJECT_DIR="$1"
TIMESTAMP=$(date +%F_%H%M%S)
CSV_REPORT="./malware_scan_$TIMESTAMP.csv"

echo "🔍 Đang quét mã độc tại: $PROJECT_DIR"
echo "📝 Xuất kết quả CSV: $CSV_REPORT"
echo "-------------------------------------------"

# Ghi tiêu đề CSV
echo "File,Line Number,Matched Pattern,Content" > "$CSV_REPORT"

# Các pattern nghi ngờ
patterns=(
  'eval *\('
  'base64_decode *\('
  'gzinflate *\('
  'file_get_contents *\(["'\'']http'
  'shell_exec *\('
  'system *\('
  'passthru *\('
  'preg_replace *\([^\)]*/e'
  'kuemeranti'
)

# Danh sách file nghi ngờ
declare -A infected_files

# Bắt đầu quét
find "$PROJECT_DIR" -type f -name "*.php" | while read -r file; do
  lineno=0
  while IFS= read -r line || [ -n "$line" ]; do
    lineno=$((lineno + 1))
    for pattern in "${patterns[@]}"; do
      if [[ "$line" =~ $pattern ]]; then
        echo "⚠️  $file:$lineno → $pattern"
        echo "\"$file\",$lineno,\"$pattern\",\"$(echo "$line" | sed 's/\"/""/g')\"" >> "$CSV_REPORT"
        infected_files["$file"]=1
        break
      fi
    done
  done < "$file"
done

echo
echo "📂 Danh sách file nghi ngờ:"
echo "----------------------------"
for f in "${!infected_files[@]}"; do
  echo "⚠️  $f"
done

echo
echo "✅ Hoàn tất. Kết quả lưu tại: $CSV_REPORT"
